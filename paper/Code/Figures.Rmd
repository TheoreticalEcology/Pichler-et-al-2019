---
title: "Figures"
author: "Maximilian Pichler"
date: "27 November 2018"
output: html_document
---

```{r setup, include=FALSE}

library(TraitMatching)
oldpar = par()
reset = function() suppressWarnings(do.call(par, oldpar))
set.seed(42)
source("Code/helpFunctions.R")
```


## Figure 2
```{r}
load(file = "Results/SimulationAggreationFig2.RData")
load(file = "Results/SimulationAggreationCIFig2.RData")

plotCI = function(x,y, ci, col, xLine = 0.07, lwd = 0.4) {
  segments(x0 = x, x1 = x, y0 =y-ci, y1 = y+ci, col = col, lwd = lwd)
  segments(x0 = x-xLine, x1 = x+xLine, y0 =y-ci, y1 = y-ci, col = col, lwd = lwd)
  segments(x0 = x-xLine, x1 = x+xLine, y0 =y+ci, y1 = y+ci, col = col, lwd = lwd)
}

cex = 0.8
cexP = 0.7
offset = c(0,0.07,0.14)
lwd = 0.7
tck=-0.025
pch = c(16, 17,15)
col_full = gray.colors(3, start = 0.0, end = 0.8, gamma = 2.2, alpha = NULL)
col = TraitMatching:::addA(col_full, 0.25)

svg("Figures/Fig2.svg",width = 5.5, height = 2.3)
par(mfrow = c(1,3), mar = c(2,1.6,1,0.3), mgp = c(1.8,0.45,0), oma = c(0.65,0.08,1,0))
## TSS
dictonary = c("DNN", "kNN", "CNN", "RF", "BRT", "naive", "SVM", "GLM")
names(dictonary) = c("dnn", "knn", "cnn", "RFranger", "boost", "naive", "SVM", "glm")
data = rbind(tss[2,,drop = FALSE],tssAB,baseCTSS)
ord = order(data[1,], decreasing = TRUE)
CIdata = rbind(tssCI[2,,drop = FALSE],tssABCI,baseCTSSCI)
data = data[,ord]
not = -which(names(data) == c("glm_step"), arr.ind = TRUE)
data = data[,not]
CIdata = CIdata[names(data)]

x = 1:ncol(data)
matplot(y = t(data),
        x = matrix(c(x,x+offset[2],x+offset[3]), ncol = 3),ylim = c(-1, 1), type = "p", pch = pch, col = col_full, cex = cexP,
        axes = TRUE,
        xlab = "",
        ylab = "", las =2,  xaxt="n", cex.axis = cex, cex.lab = cex, tck=tck)
lines(smooth.spline(y = data[1,],x = x, spar = 0.3 ), col = col[1], lwd = lwd)
lines(smooth.spline(y = data[2,],x = x+offset[2], spar = 0.3 ), col = col[2], lwd = lwd)
lines(smooth.spline(y = data[3,],x = x+offset[3], spar = 0.3 ), col = col[3], lwd = lwd)
for(i in 1:3){
  for(j in 1:ncol(data)) plotCI(j+offset[i], data[i,j], CIdata[i,j], col = col_full[i])
}
axis(1, labels = FALSE, at = x,  cex.axis = cex, las = 2, tck=tck)
text(x-0.2, par("usr")[3] - 0.07, labels = dictonary[names(data)], srt = 45, pos = 1, xpd = TRUE, cex = cex)
text(x = 0.5, pos = 4, y = 1, xpd = NA, labels = "(a)", cex = cex*1.1, font = 2)
text(x = 0.5*max(x), pos = 4, y = -0.4, xpd = NA, labels = "TSS", cex = cex, font = 1)


## AUC
data = rbind(auc[2,,drop = FALSE], aucAB, baseC)
CIdata = rbind(aucCI[2,,drop = FALSE], aucABCI, baseCCI)
ord = order(data[1,], decreasing = TRUE)
data = data[,ord]
not = -which(names(data) == c("glm_step"), arr.ind = TRUE)
data = data[,not]
CIdata = CIdata[names(data)]
x = 1:ncol(data)
matplot(y = t(data),
        x = matrix(c(x,x+offset[2],x+offset[3]), ncol = 3),ylim = c(0, 1), type = "p", pch = pch, col = col_full, cex = cexP,
        axes = TRUE,
        xlab = "",
        ylab = "", las =2,  xaxt="n",  cex.axis = cex, cex.lab = cex, tck=tck)
lines(smooth.spline(y = data[1,],x = x, spar = 0.3 ), col = col[1], lwd = lwd)
lines(smooth.spline(y = data[2,],x = x+offset[2], spar = 0.3 ), col = col[2], lwd = lwd)
lines(smooth.spline(y = data[3,],x = x+offset[3], spar = 0.3 ), col = col[3], lwd = lwd)
for(i in 1:3){
  for(j in 1:ncol(data)) plotCI(j+offset[i], data[i,j], CIdata[i,j], col = col_full[i])
}

axis(1, labels = FALSE, at = x,  cex.axis = cex, las = 2, tck=tck)
text(x-0.2, par("usr")[3] - 0.035, labels = dictonary[names(data)], srt = 45, pos = 1, xpd = TRUE, cex = cex)
text(x = 0.5, pos = 4, y = 1, xpd = NA, labels = "(b)", cex = cex*1.1, font = 2)
text(x = 0.5*max(x), pos = 4, y = 0.3, xpd = NA, labels = "AUC", cex = cex, font = 1)
points(x = c(-8,1,10), y = rep(-0.23,3), pch = rev(pch), col = rev(col_full), xpd = NA)
text(x =  c(-8,1,10), y = rep(-0.23,3), pos = 4, 
    labels = rev(c("Trait-matching ", 
                 "Baseline 2", 
                 "Baseline 1")), xpd = NA, cex = cex)

## Spearman Rho correlation factor
dictonary = c("DNN", "kNN", "CNN", "RF", "BRT", "naive", "SVM", "GLM")
names(dictonary) = c("negBinDnn", "knn", "cnn", "RFranger", "boost", "naive", "SVM", "glm")
data = rbind(spear[2,,drop = FALSE], spearAB, baseR)
CIdata = rbind(spearCI[2,,drop = FALSE], spearABCI, baseRCI)
ord = order(data[1,], decreasing = TRUE)
data = data[,ord]
not = -which(names(data) == c("glm_step"), arr.ind = TRUE)
data = data[,not]
CIdata = CIdata[names(data)]
x = 1:ncol(data)
matplot(y = t(data),
        x = matrix(c(x,x+offset[2],x+offset[3]), ncol = 3),ylim = c(-1, 1), type = "p", pch = pch, col = col_full, cex = cexP,
        axes = TRUE,
        xlab = "",
        ylab = "", las =2,  xaxt="n",  cex.axis = cex, cex.lab = cex, tck=tck)
lines(smooth.spline(y = data[1,],x = x, spar = 0.3 ), col = col[1], lwd = lwd)
lines(smooth.spline(y = data[2,],x = x+offset[2], spar = 0.3 ), col = col[2], lwd = lwd)
lines(smooth.spline(y = data[3,],x = x+offset[3], spar = 0.3 ), col = col[3], lwd = lwd)
for(i in 1:3){
  for(j in 1:ncol(data)) plotCI(j+offset[i], data[i,j], CIdata[i,j], col = col_full[i])
}
axis(1, labels = FALSE, at = x,  cex.axis = cex, las = 2, tck=tck)
text(x-0.17, par("usr")[3] - 0.07, labels = dictonary[names(data)], srt = 45, pos = 1, xpd = TRUE, cex = cex)
text(x = 0.63, pos = 4, y = 1, xpd = NA, labels = "(c)", cex = cex*1.1, font = 2)
text(x = 0.5*max(x), pos = 4, y = -0.4, xpd = NA, labels = "Spearman", cex = cex, font = 1)

dev.off()
```






## Figure 3
```{r}
Results = readRDS(file = "Results/aggregatedResults.RDS")
test = Results$combinedTable[Results$combinedTable$set == "test",]
train = Results$combinedTable[Results$combinedTable$set == "train",]
colnames(test) = c("auc", "f1", "bac", "acc", "fdr", "fpr", "npv", "precision","specificity", "sensitivity", "tss", "set", "method")
colnames(train) = c("auc", "f1", "bac", "acc", "fdr", "fpr", "npv", "precision","specificity", "sensitivity", "tss", "set", "method")
test = test[order(test$tss, decreasing = F),]
bestTest = test[!duplicated(test$method),]
bestTrain = train[paste0(rep("tr",7),substr(rownames(bestTest),3,4)),]

library(Aranea)
cols =c("#bfa23d","#5d3686","#6ca24d","#c26abb","#46c19a","#ba496b","#6c7ed7","#b55c36")
names(cols) = c("dnn","cnn","knn","SVM","naive","RFranger","boost", "glm")
addA = function(col, alpha = 0.25) apply(sapply(col, col2rgb)/255, 2, function(x) rgb(x[1], x[2], x[3], alpha=alpha)) 
multiCoords = matrix(0,9,4)
multiCoords[1,] = c(0.25, 0.75, 1/3, 1)
multiCoords[c(2:4),2] = 0.25  
multiCoords[c(2:4),3] = c(2/3,1/3,0) 
multiCoords[c(2:4),4] = c(1,2/3,1/3)
multiCoords[c(4:7),4] = 1/3
multiCoords[c(4:7),1] = seq(0,0.75,0.25)
multiCoords[c(4:7),2] = seq(0.25,1,0.25)
multiCoords[8,] = c(0.75,1,1/3,2/3)
multiCoords[9,] = c(multiCoords[8,c(1,2)], multiCoords[2,c(3,4)])
dictonary = c("DNN", "kNN", "CNN", "RF", "BRT", "naive", "SVM", "GLM")
names(dictonary) = c("dnn", "knn", "cnn", "RFranger", "boost", "naive", "SVM", "glm")

svg(file = "./Figures/Fig3.svg", width = 5.5, height = 3.83)
par(mfcol = c(1,1), oma = c(1.5,0,0,0) + 0.1, mar = c(0,0,0,0)+0.3, las=1, mgp=c(1.5, 0.5, 0), lwd=75/75, cex.axis=3/3, cex.lab=2/3, tcl=(-0.2),font.axis = 2, bty="l")
bestTest2 = bestTest %>% mutate(tss = (tss+1)/2)
bestTrain2 = bestTrain%>% mutate(tss = (tss+1)/2)
cols = cols[as.character(bestTest2$method)]
Aranea::multiSpider(x1 = bestTest2[,c(1,4,8:11)], x2 = bestTrain2[,c(1,4,8:11)],
                    cexSteps = c(NA,0.7),cexProcent = c(0.5,0.5), 
                    alphaRec = 0.3, alphaSpider = 0.4, 
                    colRec = cols, 
                    colRecBorder  = cols,
                    titles =  dictonary[names(cols)], cexPoints = 0.5, 
                    stepsText = c("AUC", "ACC", "Prec", "Spec", "Sens", "TSS in %"), 
                    twistSteps = 29,circleLines = c(5,3),
                    rectangular = F, multiCoords = multiCoords, cexTitles = 0.7)
legend(x = 6,y = -14.3,border = "n",legend = c("Validation", "Training"), lty = c(1,2),xpd = NA, cex = 0.7, bty = "n", text.font = 1, horiz = TRUE)
dev.off()

write.table(cbind(round(bestTest[,-c(6,7,12:14)], digits = 3), method = bestTest$method),file = "Results/Table3.txt")

```


## Figure 4

```{r,results=FALSE}
plotCI = function(x,y, ci, col, xLine = 0.01, lwd = 0.4) {
  segments(x0 = x, x1 = x, y0 =y-ci, y1 = min(1,y+ci), col = col, lwd = lwd)
  segments(x0 = x-xLine, x1 = x+xLine, y0 =y-ci, y1 = y-ci, col = col, lwd = lwd)
  segments(x0 = x-xLine, x1 = x+xLine, y0 =min(1,y+ci), y1 = min(1,y+ci), col = col, lwd = lwd)
}
cexP = 0.65
cols =c("#bfa23d", "#5d3686", "#6ca24d", "#c26abb", "#46c19a", "#ba496b", "#6c7ed7","#b55c36")
names(cols) = c("DNN","cnn","kNN","SVM","naive","RF","BRT", "GLM")
load(file = "Results/glmInferenceTPR.RData")
resAggSmallReg = readRDS(file = "Results/resAggSmallReg.RDS")
resAggSmallClass = readRDS(file = "Results/resAggSmallClass.RDS")

resAggMiddleReg = readRDS(file = "Results/resAggMiddleReg.RDS")
resAggMiddleClass = readRDS(file = "Results/resAggMiddleClass.RDS")
load(file = "Results/glmInferenceTPR.RData")

smallRegGLM = data.frame(model = rep("glm",4), len_true = 1:4, trp = TPRpR, tprCI = TPRpCCI)
smallClassGLM = data.frame(model = rep("glm",4), len_true = 1:4, trp = TPRpC, tprCI = TPRpRCI)

dictonary = c("DNN", "kNN", "RF", "BRT","GLM")
names(dictonary) = c("classif.keras_seq.tuned", "classif.kknn.tuned", "classif.randomForest.tuned", "classif.xgboost.tuned","glm")

dictonary = c("DNN", "kNN", "RF", "BRT","GLM")
names(dictonary) = c("classif.keras_seq.tuned", "classif.kknn.tuned", "classif.randomForest.tuned", "classif.xgboost.tuned","glm")
ResClass = bind_rows(resAggSmallClass[,c(1,2,3,9)], smallClassGLM)
ResClassT = tapply(ResClass$trp, list(factor(ResClass$len_true),ResClass$model), simplify = TRUE, FUN = function(i)i)
ResClassTCI = tapply(ResClass$tprCI, list(factor(ResClass$len_true),ResClass$model), simplify = TRUE, FUN = function(i)i)
means = apply(ResClassT, 2, mean)
ord = order(means, decreasing = TRUE)

plotInf = function(res,ci, xlab = "", ylab = "", col = rep("black", 7), between = 0.4){
  plotSize = 1*(1-between)
  groupSize = plotSize/ncol(res)
  pointBaseX = seq(0,groupSize, length.out = nrow(res))
  emptySize = between/(ncol(res)-1)
  baseX = (0:(ncol(res) - 1))*(emptySize+groupSize)
  coords = matrix(NA, nrow = ncol(res), 4)
  for(i in 1:nrow(coords)) coords[i,] = baseX[i]+pointBaseX
  counter = 1
  plot(NULL, NULL, xlim = c(0,1), ylim = c(0,1), axes = TRUE,xaxt = "n", xlab = xlab , ylab = ylab, yaxt = "n")
  km = apply(res,2,mean)
  for(i in 1:5){
    segments(x0 = min(coords[i,])-0.03, x1 = max(coords[i,])+0.03, y0 = km[i], y1 = km[i], lty = 1, col = "red", xpd = NA, lwd = 0.6)
    x = 1:4
    m = lm(res[,i]~scale(x))
      ce = coef(m)
      cc= c(coords[i,])
      segments(x0 = min(cc)-0.03, x1 = max(cc)+0.03, y0 = ce[1]-mean(cc)*ce[2], y1 = ce[1]+mean(cc)*ce[2], lty =2 , col = "red", lwd = 0.6)
  }
  for(i in 1:ncol(res)) points(x = coords[i,], y = res[,i], col = col[i], pch = 16,cex = 0.5)
  for(i in 1:ncol(res)) {
    for(j in 1:nrow(res)) plotCI(x = coords[i,j], y = res[j,i], ci[j,i], col = "black")
  }
  km = apply(res,2,mean)
  return(coords)
}

wideX = function(co) seq(min(co)-0.01, max(co)+0.01, length.out = 4)  

svg(file = "Figures/Fig4.svg", width = 5.50, height = 1.8)
par(mfrow = c(1,2),  mar = c(1.0,1.4,0.4, 0.3), oma = c(0,0.0,0.4,0), mgp = c(3,0.27,0))

dictonary = c("DNN", "kNN", "RF", "BRT","GLM")
names(dictonary) = c("classif.keras_seq.tuned", "classif.kknn.tuned", "classif.randomForest.tuned", "classif.xgboost.tuned","glm")
ResClass = bind_rows(resAggSmallClass[,c(1,2,3,9)], smallClassGLM)
ResClassT = tapply(ResClass$trp, list(factor(ResClass$len_true),ResClass$model), simplify = TRUE, FUN = function(i)i)
ResClassTCI = tapply(ResClass$tprCI, list(factor(ResClass$len_true),ResClass$model), simplify = TRUE, FUN = function(i)i)
means = apply(ResClassT, 2, mean)
ord = order(means, decreasing = TRUE)
right_order = dictonary[names(means)[order(means, decreasing = TRUE)]]
coords = plotInf(ResClassT[,ord], ResClassTCI[,ord], between = 0.7)
axis(2, las = 2, cex.axis = cexP, tck = -0.02)
text(labels = dictonary[colnames(ResClassT)[ord]], 
     x = apply(coords,1, function(co) mean(co)), y = -0.02, pos = 1, xpd = NA, cex = cexP)
text(labels = "TPR", x = 0.87, y = 0.97, xpd = NA, pos = 4, cex = cexP, font =1)
text(labels = "(a)", x = 0.02, y = 1.09, xpd = NA, pos = 2, cex = cexP*1.1, font =2)

dictonary = c("DNN", "kNN", "RF", "BRT","GLM")
names(dictonary) = c("regr.negBinDnn.tuned", "regr.kknn.tuned", "regr.randomForest.tuned", "regr.xgboost.tuned","glm")
ResReg = bind_rows(resAggSmallReg[,c(1,2,3,9)], smallRegGLM)
ResRegT = tapply(ResReg$trp, list(factor(ResReg$len_true),ResReg$model), simplify = TRUE, FUN = function(i) i)
ResRegTCI = tapply(ResReg$tprCI, list(factor(ResReg$len_true),ResReg$model), simplify = TRUE, FUN = function(i)i)
means = apply(ResRegT, 2, mean)
ord = order(means, decreasing = TRUE)
ord = sapply(right_order, function(x) which(x == dictonary[colnames(ResRegT)], arr.ind = TRUE))

coords = plotInf(ResRegT[,ord], ResRegTCI[,ord], between = 0.7)
axis(2, las = 2, cex.axis = cexP, tck = -0.02)
text(labels = dictonary[colnames(ResRegT)[ord]], 
     x = apply(coords,1, function(co) mean(co)), y = -0.02, pos = 1, xpd = NA, cex = cexP)
text(labels = "TPR", x = 0.87, y = 0.97, xpd = NA, pos = 4, cex = cexP, font =1)
text(labels = "(b)", x = 0.02, y = 1.09, xpd = NA, pos = 2, cex = cexP*1.1, font =2)
dev.off()
```

## Figure 5
```{r,results=FALSE}
load(file = "Results/HummingInferenceResult.RData")
humT = c( "Bill.Length", "Bill.Curvature", "Body.Mass","Wing" , "Tail" , "plot.Low", "plot.Mid", "plot.High")
plantT = c( "Corolla.Length","Corolla.Curvature", "Corolla.Volumen","Inner.Diameter", "Ext.Diameter")
interHum = apply(rbind(expand.grid(humT, plantT), expand.grid( plantT, humT)), 1, function(x) paste0(x[1],":", x[2]))
reset()
cexP = 0.9

svg(file = "Figures/Fig5.svg", width = 5.5, height = 3.7)
par(mfrow = c(1,2),mar = c(0.3,1,1,3)+0.0,oma = c(1,0.3,2,1))
# Fig5a
plot(NULL,NULL, xlim = c(0,1), ylim = c(0,1), axes = F, xlab = "", ylab = "")
#text(x = -0.06, y = 1.03, labels = "(a)", cex = 0.9, xpd = NA, font = 2)
polygon(c(0,0.125,0.17,0.19,0.35,0.51,0.65,0.85), c(0,0.25,0.5,0.42,1,0.35,0.09,0), lwd = 2, col = "lightgrey", xpd = NA)
baseX = 0.72
baseYv = c(0.1,0.4,0.7)
cols = RColorBrewer::brewer.pal(3, "Accent")
altitude = c("50 m.a.s.l", "1000 m.a.s.l", "2000 m.a.s.l")
lineY = baseYv+0.05
for(i in 1:3) {
  baseY = baseYv[i]
  rect(xleft = baseX, xright = baseX+0.025,ybottom = baseY,ytop = baseY+0.1, col = cols[i], lwd = 0.8)
  rect(xleft = baseX+0.035, xright = baseX+0.135,ybottom = baseY,ytop = baseY+0.1, col = cols[i], lwd = 0.8)
  rect(xleft = baseX+0.035, xright = baseX+0.135,ybottom = baseY+0.11,ytop = baseY+0.135, col = cols[i], lwd = 0.8)
  y = lineY[i]
  lines(y = rep(y,2), x = c(0.0,baseX-0.05), lty = 3, lwd = 1.2, xpd = NA)
  text(y = y+0.03, x = -0.15, labels = altitude[i], cex = 0.7, pos = 4, xpd = NA, font = 2)
}
text(x = 0.85, y = baseYv[1]+0.05,pos = 4, xpd = NA, cex = 0.9, labels = "Low", font = 2)
text(x = 0.85, y = baseYv[2]+0.05,pos = 4, xpd = NA, cex = 0.9, labels = "Mid", font = 2)
text(x = 0.85, y = baseYv[3]+0.05,pos = 4, xpd = NA, cex = 0.9, labels = "High", font = 2)
text(x = 0.35, y = 0, pos = 3, labels = "Costa Rica", cex = 0.9, font = 2)

par(mar = c(1,3,2,0.2)+0.0)

best = ResultInterCombined$rf
best$pairwise_interactions = best$pairwise_interactions[order(best$pairwise_interactions$Interactions,decreasing = TRUE),, drop = FALSE]

groups = list(a = humT, b = plantT)
drawRankingMatrix2(best, groups = groups, cex = 0.7, top_n = 8)

for(i in 8:1){
  rect(ytop = -0.04,ybottom = -0.07,xleft = seq(0.0,1,length.out = 9)[i],xright = seq(0,1,length.out = 9)[i+1], col = rev(RColorBrewer::brewer.pal(8,name = "YlGnBu"))[i],border = NA, xpd = NA)
}
text(y= -0.07,x = rev(seq(0, seq(0,1,length.out = 9)[8], length.out = 8))+0.03, labels = 8:1, pos = 1, font = 2, cex = 0.7, xpd = NA)
mtext(side = 3, text = c("(a)", "(b)"),line = 3,at = c(-1.7,-0.5), font = 2, cex = 0.9)
dev.off()
```



## Figure S1
```{r}
svg(file = "Figures/FigS1.svg", width = 5.5, height = 3)
x = seq(0.01,1,0.01)
par(mfrow = c(1,2), mar = c(2, 4.2, 0.2, 0.5), oma = c(0,0,0,0), mgp = c(2, 0.8,0))
plot(y = x/rev(x),x = 1:100, type = "l", xlab = "", ylab = "TraitA / TraitB", las = 2, axes = FALSE,  cex.lab = 0.7)
axis(2, las = 2, cex.axis = 0.7)
axis(1,labels = c("0/1", "1/0"), at = c(1,100), cex.axis = 0.7)
plot(y = log(x/rev(x)),x= 1:100, type = "l", xlab = "", ylab = "log(TraitA / TraitB)", las = 2, axes = FALSE, cex.lab = 0.7)
axis(2, las = 2, cex.axis = 0.7)
axis(1,labels = c("0/1", "1/0"), at = c(1,100), cex.axis = 0.7)
dev.off()
```




## Figure S2
```{r}
load(file = "Results/SimulationAggreationFig2.RData")
load(file = "Results/SimulationAggreationCIFig2.RData")

plotCI = function(x,y, ci, col, xLine = 0.07, lwd = 0.4) {
  segments(x0 = x, x1 = x, y0 =y-ci, y1 = y+ci, col = col, lwd = lwd)
  segments(x0 = x-xLine, x1 = x+xLine, y0 =y-ci, y1 = y-ci, col = col, lwd = lwd)
  segments(x0 = x-xLine, x1 = x+xLine, y0 =y+ci, y1 = y+ci, col = col, lwd = lwd)
}

svg("Figures/FigS2.svg",width = 5.5, height = 4.6)
par(mfrow = c(2,3), mar = c(2,1.6,1,0.3), mgp = c(1.8,0.5,0), oma = c(0.6,0,1,0))


cex = 0.65
cexP = 0.7
offset = c(0,0.07,0.14)
lwd = 0.7
tck=-0.03
# Network wizes
##A
dictonary = c("DNN", "kNN", "CNN", "RF", "BRT", "naive", "SVM", "GLM")
names(dictonary) = c("dnn", "knn", "cnn", "RFranger", "boost", "naive", "SVM", "glm")
data = rbind(tss[1,,drop = FALSE], tss[2,,drop = FALSE], tss[3,,drop = FALSE])
ord = order(data[1,], decreasing = TRUE)
CIdata = rbind(tssCI[1,,drop = FALSE],tssCI[2,,drop = FALSE],tssCI[3,,drop = FALSE])
data = data[,ord]
not = -which(names(data) == c("glm_step"), arr.ind = TRUE)
data = data[,not]
CIdata = CIdata[names(data)]
pch = c(16, 17,15)
col_full = gray.colors(3, start = 0.0, end = 0.8, gamma = 2.2, alpha = NULL)
col = TraitMatching:::addA(col_full, 0.25)
x = 1:ncol(data)
matplot(y = t(data),
        x = matrix(c(x,x+offset[2],x+offset[3]), ncol = 3),ylim = c(-1, 1), type = "p", pch = pch, col = col_full, cex = cexP,
        axes = TRUE,
        xlab = "",
        ylab = "", las =2,  xaxt="n", cex.axis = cex, cex.lab = cex, tck=tck)
lines(smooth.spline(y = data[1,],x = x, spar = 0.3 ), col = col[1], lwd = lwd)
lines(smooth.spline(y = data[2,],x = x+offset[2], spar = 0.3 ), col = col[2], lwd = lwd)
lines(smooth.spline(y = data[3,],x = x+offset[3], spar = 0.3 ), col = col[3], lwd = lwd)
for(i in 1:3){
  for(j in 1:ncol(data)) plotCI(j+offset[i], data[i,j], CIdata[i,j], col = col_full[i])
}
axis(1, labels = FALSE, at = x,  cex.axis = cex, las = 2, tck=tck)
text(x-0.2, par("usr")[3] - 0.07, labels = dictonary[names(data)], srt = 45, pos = 1, xpd = TRUE, cex = cex)
text(x = 0.5, pos = 4, y = 1, xpd = NA, labels = "(a)", cex = cex*1.1, font = 2)
text(x = 0.5*max(x), pos = 4, y = -0.4, xpd = NA, labels = "TSS", cex = cex, font = 1)
## B
data = rbind(auc[1,,drop = FALSE],auc[2,,drop = FALSE],auc[3,,drop = FALSE])
CIdata = rbind(aucCI[1,,drop = FALSE], aucCI[2,,drop = FALSE], aucCI[3,,drop = FALSE])
ord = order(data[1,], decreasing = TRUE)
data = data[,ord]
not = -which(names(data) == c("glm_step"), arr.ind = TRUE)
data = data[,not]
CIdata = CIdata[names(data)]
x = 1:ncol(data)
matplot(y = t(data),
        x = matrix(c(x,x+offset[2],x+offset[3]), ncol = 3),ylim = c(0, 1), type = "p", pch = pch, col = col_full, cex = cexP,
        axes = TRUE,
        xlab = "",
        ylab = "", las =2,  xaxt="n",  cex.axis = cex, cex.lab = cex, tck=tck)
lines(smooth.spline(y = data[1,],x = x, spar = 0.3 ), col = col[1], lwd = lwd)
lines(smooth.spline(y = data[2,],x = x+offset[2], spar = 0.3 ), col = col[2], lwd = lwd)
lines(smooth.spline(y = data[3,],x = x+offset[3], spar = 0.3 ), col = col[3], lwd = lwd)
for(i in 1:3){
  for(j in 1:ncol(data)) plotCI(j+offset[i], data[i,j], CIdata[i,j], col = col_full[i])
}

axis(1, labels = FALSE, at = x,  cex.axis = cex, las = 2, tck=tck)
text(x-0.2, par("usr")[3] - 0.035, labels = dictonary[names(data)], srt = 45, pos = 1, xpd = TRUE, cex = cex)
text(x = 0.5, pos = 4, y = 1, xpd = NA, labels = "(b)", cex = cex*1.1, font = 2)
text(x = 0.5*max(x), pos = 4, y = 0.3, xpd = NA, labels = "AUC", cex = cex, font = 1)
#text(x = 0.5*max(x), pos = 4, y = -0.4, xpd = NA, labels = "TSS", cex = cex, font = 1)
points(x = c(-8,0,9), y = rep(-0.22,3), pch = rev(pch), col = rev(col_full), xpd = NA)
text(x =  c(-8,0,9), y = rep(-0.22,3), pos = 4, 
    labels = rev(c("25 * 50 (plants * pollinators)", 
                 "50 * 100 (plants * pollinators)", 
                 "100 * 200 (plants * pollinators)")), xpd = NA, cex = cex)

## C
dictonary = c("DNN", "kNN", "CNN", "RF", "BRT", "naive", "SVM", "GLM")
names(dictonary) = c("negBinDnn", "knn", "cnn", "RFranger", "boost", "naive", "SVM", "glm")
data = rbind(spear[1,,drop = FALSE], spear[2,,drop = FALSE], spear[3,,drop = FALSE])
CIdata = rbind(spearCI[1,,drop = FALSE], spearCI[2,,drop = FALSE], spearCI[3,,drop = FALSE])
ord = order(data[1,], decreasing = TRUE)
data = data[,ord]
not = -which(names(data) == c("glm_step"), arr.ind = TRUE)
data = data[,not]
CIdata = CIdata[names(data)]
x = 1:ncol(data)
matplot(y = t(data),
        x = matrix(c(x,x+offset[2],x+offset[3]), ncol = 3),ylim = c(-1, 1), type = "p", pch = pch, col = col_full, cex = cexP,
        axes = TRUE,
        xlab = "",
        ylab = "", las =2,  xaxt="n",  cex.axis = cex, cex.lab = cex, tck=tck)
lines(smooth.spline(y = data[1,],x = x, spar = 0.3 ), col = col[1], lwd = lwd)
lines(smooth.spline(y = data[2,],x = x+offset[2], spar = 0.3 ), col = col[2], lwd = lwd)
lines(smooth.spline(y = data[3,],x = x+offset[3], spar = 0.3 ), col = col[3], lwd = lwd)
for(i in 1:3){
  for(j in 1:ncol(data)) plotCI(j+offset[i], data[i,j], CIdata[i,j], col = col_full[i])
}
axis(1, labels = FALSE, at = x,  cex.axis = cex, las = 2, tck=tck)
text(x-0.17, par("usr")[3] - 0.07, labels = dictonary[names(data)], srt = 45, pos = 1, xpd = TRUE, cex = cex)
text(x = 0.63, pos = 4, y = 1, xpd = NA, labels = "(c)", cex = cex*1.1, font = 2)
#text(x = 0.76*max(x), pos = 4, y = 1, xpd = NA, labels = "Spearman", cex = cex, font = 1)
text(x = 0.5*max(x), pos = 4, y = -0.4, xpd = NA, labels = "Spearman", cex = cex, font = 1)


# Abundance
## D
cex = 0.65
cexP = 0.7
offset = c(0,0.07,0.14)
lwd = 0.7
tck=-0.03
dictonary = c("DNN", "kNN", "CNN", "RF", "BRT", "naive", "SVM", "GLM")
names(dictonary) = c("dnn", "knn", "cnn", "RFranger", "boost", "naive", "SVM", "glm")
data = rbind( tssObs[1,,drop = FALSE], tssObs[2,,drop = FALSE], tssObs[3,,drop = FALSE])
ord = order(data[1,], decreasing = TRUE)
CIdata = rbind(tssObsCI[1,,drop = FALSE],tssObsCI[2,,drop = FALSE],tssObsCI[3,,drop = FALSE])
data = data[,ord]
not = -which(names(data) == c("glm_step"), arr.ind = TRUE)
data = data[,not]
CIdata = CIdata[names(data)]
pch = c(16, 17,15)
col_full = gray.colors(3, start = 0.0, end = 0.8, gamma = 2.2, alpha = NULL)
col = TraitMatching:::addA(col_full, 0.25)
x = 1:ncol(data)
matplot(y = t(data),
        x = matrix(c(x,x+offset[2],x+offset[3]), ncol = 3),ylim = c(-1, 1), type = "p", pch = pch, col = col_full, cex = cexP,
        axes = TRUE,
        xlab = "",
        ylab = "", las =2,  xaxt="n", cex.axis = cex, cex.lab = cex, tck=tck)
lines(smooth.spline(y = data[1,],x = x, spar = 0.3 ), col = col[1], lwd = lwd)
lines(smooth.spline(y = data[2,],x = x+offset[2], spar = 0.3 ), col = col[2], lwd = lwd)
lines(smooth.spline(y = data[3,],x = x+offset[3], spar = 0.3 ), col = col[3], lwd = lwd)
for(i in 1:3){
  for(j in 1:ncol(data)) plotCI(j+offset[i], data[i,j], CIdata[i,j], col = col_full[i])
}
axis(1, labels = FALSE, at = x,  cex.axis = cex, las = 2, tck=tck)
text(x-0.2, par("usr")[3] - 0.07, labels = dictonary[names(data)], srt = 45, pos = 1, xpd = TRUE, cex = cex)
text(x = 0.5, pos = 4, y = 1, xpd = NA, labels = "(d)", cex = cex*1.1, font = 2)
text(x = 0.5*max(x), pos = 4, y = -0.4, xpd = NA, labels = "TSS", cex = cex, font = 1)
## E
data = rbind(aucObs[1,,drop = FALSE],  aucObs[2,,drop = FALSE],  aucObs[3,,drop = FALSE] )
CIdata = rbind(aucObsCI[1,,drop = FALSE], aucObsCI[2,,drop = FALSE], aucObsCI[3,,drop = FALSE])
ord = order(data[1,], decreasing = TRUE)
data = data[,ord]
not = -which(names(data) == c("glm_step"), arr.ind = TRUE)
data = data[,not]
CIdata = CIdata[names(data)]
x = 1:ncol(data)
matplot(y = t(data),
        x = matrix(c(x,x+offset[2],x+offset[3]), ncol = 3),ylim = c(0, 1), type = "p", pch = pch, col = col_full, cex = cexP,
        axes = TRUE,
        xlab = "",
        ylab = "", las =2,  xaxt="n",  cex.axis = cex, cex.lab = cex, tck=tck)
lines(smooth.spline(y = data[1,],x = x, spar = 0.3 ), col = col[1], lwd = lwd)
lines(smooth.spline(y = data[2,],x = x+offset[2], spar = 0.3 ), col = col[2], lwd = lwd)
lines(smooth.spline(y = data[3,],x = x+offset[3], spar = 0.3 ), col = col[3], lwd = lwd)
for(i in 1:3){
  for(j in 1:ncol(data)) plotCI(j+offset[i], data[i,j], CIdata[i,j], col = col_full[i])
}
axis(1, labels = FALSE, at = x,  cex.axis = cex, las = 2, tck=tck)
text(x-0.2, par("usr")[3] - 0.035, labels = dictonary[names(data)], srt = 45, pos = 1, xpd = TRUE, cex = cex)
text(x = 0.5, pos = 4, y = 1, xpd = NA, labels = "(e)", cex = cex*1.1, font = 2)
text(x = 0.5*max(x), pos = 4, y = 0.3, xpd = NA, labels = "AUC", cex = cex, font = 1)
points(x = c(-8,0,9), y = rep(-0.22,3), pch = rev(pch), col = rev(col_full), xpd = NA)
text(x =  c(-8,0,9), y = rep(-0.22,3), pos = 4, 
    labels = rev(c("short observation", 
                 "middle observation)", 
                 "long observation")), xpd = NA, cex = cex)

## F
dictonary = c("DNN", "kNN", "CNN", "RF", "BRT", "naive", "SVM", "GLM")
names(dictonary) = c("negBinDnn", "knn", "cnn", "RFranger", "boost", "naive", "SVM", "glm")
data = rbind(spearObs[1,,drop = FALSE], spearObs[2,,drop = FALSE], spearObs[3,,drop = FALSE])
CIdata = spearObsCI
ord = order(data[1,], decreasing = TRUE)
data = data[,ord]
not = -which(names(data) == c("glm_step"), arr.ind = TRUE)
data = data[,not]
CIdata = CIdata[names(data)]
x = 1:ncol(data)
matplot(y = t(data),
        x = matrix(c(x,x+offset[2],x+offset[3]), ncol = 3),ylim = c(-1, 1), type = "p", pch = pch, col = col_full, cex = cexP,
        axes = TRUE,
        xlab = "",
        ylab = "", las =2,  xaxt="n",  cex.axis = cex, cex.lab = cex, tck=tck)
lines(smooth.spline(y = data[1,],x = x, spar = 0.3 ), col = col[1], lwd = lwd)
lines(smooth.spline(y = data[2,],x = x+offset[2], spar = 0.3 ), col = col[2], lwd = lwd)
lines(smooth.spline(y = data[3,],x = x+offset[3], spar = 0.3 ), col = col[3], lwd = lwd)
for(i in 1:3){
  for(j in 1:ncol(data)) plotCI(j+offset[i], data[i,j], CIdata[i,j], col = col_full[i])
}
axis(1, labels = FALSE, at = x,  cex.axis = cex, las = 2, tck=tck)
text(x-0.17, par("usr")[3] - 0.07, labels = dictonary[names(data)], srt = 45, pos = 1, xpd = TRUE, cex = cex)
text(x = 0.63, pos = 4, y = 1, xpd = NA, labels = "(f)", cex = cex*1.1, font = 2)
text(x = 0.5*max(x), pos = 4, y = -0.4, xpd = NA, labels = "Spearman", cex = cex, font = 1)
dev.off()
```




## Figure S3
```{r}
plotCI = function(x,y, ci, col, xLine = 0.01, lwd = 0.4) {
  segments(x0 = x, x1 = x, y0 =y-ci, y1 = min(1,y+ci), col = col, lwd = lwd)
  segments(x0 = x-xLine, x1 = x+xLine, y0 =y-ci, y1 = y-ci, col = col, lwd = lwd)
  segments(x0 = x-xLine, x1 = x+xLine, y0 =min(1,y+ci), y1 = min(1,y+ci), col = col, lwd = lwd)
}
cols =c("#bfa23d", "#5d3686","#6ca24d","#c26abb","#46c19a","#ba496b","#6c7ed7","#b55c36")
names(cols) = c("DNN","cnn","kNN","SVM","naive","RF","BRT", "GLM")
load(file = "Results/glmInferenceTPR.RData")
resAggSmallReg = readRDS(file = "Results/resAggSmallReg.RDS")
resAggSmallClass = readRDS(file = "Results/resAggSmallClass.RDS")
resAggMiddleReg = readRDS(file = "Results/resAggMiddleReg.RDS")
resAggMiddleClass = readRDS(file = "Results/resAggMiddleClass.RDS")
load(file = "Results/glmInferenceTPR.RData")
smallRegGLM = data.frame(model = rep("glm",4), len_true = 1:4, trp = TPRpR, tprCI = TPRpCCI)
smallClassGLM = data.frame(model = rep("glm",4), len_true = 1:4, trp = TPRpC, tprCI = TPRpRCI)
dictonary = c("DNN", "kNN", "RF", "BRT","GLM")
names(dictonary) = c("classif.keras_seq.tuned", "classif.kknn.tuned", "classif.randomForest.tuned", "classif.xgboost.tuned","glm")

dictonary = c("DNN", "kNN", "RF", "BRT","GLM")
names(dictonary) = c("classif.keras_seq.tuned", "classif.kknn.tuned", "classif.randomForest.tuned", "classif.xgboost.tuned","glm")
ResClass = bind_rows(resAggMiddleClass[,c(1,2,3,9)], smallClassGLM)
ResClassT = tapply(ResClass$trp, list(factor(ResClass$len_true),ResClass$model), simplify = TRUE, FUN = function(i)i)
ResClassTCI = tapply(ResClass$tprCI, list(factor(ResClass$len_true),ResClass$model), simplify = TRUE, FUN = function(i)i)
means = apply(ResClassT, 2, mean)
ord = order(means, decreasing = TRUE)

plotInf = function(res,ci, xlab = "", ylab = "", col = rep("black", 7), between = 0.4){
  plotSize = 1*(1-between)
  groupSize = plotSize/ncol(res)
  pointBaseX = seq(0,groupSize, length.out = nrow(res))
  emptySize = between/(ncol(res)-1)
  baseX = (0:(ncol(res) - 1))*(emptySize+groupSize)
  coords = matrix(NA, nrow = ncol(res), 4)
  for(i in 1:nrow(coords)) coords[i,] = baseX[i]+pointBaseX
  counter = 1
  plot(NULL, NULL, xlim = c(0,1), ylim = c(0,1), axes = TRUE,xaxt = "n", xlab = xlab , ylab = ylab, yaxt = "n")
  km = apply(res,2,mean)
  for(i in 1:ncol(res)){
    segments(x0 = min(coords[i,])-0.03, x1 = max(coords[i,])+0.03, y0 = km[i], y1 = km[i], lty = 1, col = "red", xpd = NA, lwd = 0.6)
    x = 1:4
    ce = coef(lm(res[,i]~scale(x)))
    cc= c(coords[i,])
    segments(x0 = min(cc)-0.03, x1 = max(cc)+0.03, y0 = ce[1]-mean(cc)*ce[2], y1 = ce[1]+mean(cc)*ce[2], lty =2 , col = "red", lwd = 0.6)
  }
  for(i in 1:ncol(res)) points(x = coords[i,], y = res[,i], col = col[i], pch = 16,cex = 0.5)
  for(i in 1:ncol(res)) {
    for(j in 1:nrow(res)) plotCI(x = coords[i,j], y = res[j,i], ci[j,i], col = "black")
  }
  km = apply(res,2,mean)
 
  return(coords)
}

wideX = function(co) seq(min(co)-0.01, max(co)+0.01, length.out = 4)  

svg(file = "Figures/FigS3.svg", width = 2.25, height = 1.8)
par(mfrow = c(1,2),  mar = c(1.0,1.4,0.4, 0.3), oma = c(0,0.0,0.4,0), mgp = c(3,0.27,0))
dictonary = c("DNN", "kNN", "RF", "BRT","GLM")
names(dictonary) = c("classif.keras_seq.tuned", "classif.kknn.tuned", "classif.randomForest.tuned", "classif.xgboost.tuned","glm")
ResClass = bind_rows(resAggMiddleClass[,c(1,2,3,9)])
ResClassT = tapply(ResClass$trp, list(factor(ResClass$len_true),ResClass$model), simplify = TRUE, FUN = function(i)i)
ResClassTCI = tapply(ResClass$tprCI, list(factor(ResClass$len_true),ResClass$model), simplify = TRUE, FUN = function(i)i)
means = apply(ResClassT, 2, mean)
ord = order(means, decreasing = TRUE)
right_order = dictonary[names(means)[order(means, decreasing = TRUE)]]
coords = plotInf(ResClassT[,ord], ResClassTCI[,ord], between = 0.4)
axis(2, las = 2, cex.axis = cexP, tck = -0.02)
text(labels = dictonary[colnames(ResClassT)[ord]], 
     x = apply(coords,1, function(co) mean(co)), y = -0.02, pos = 1, xpd = NA, cex = cexP)
text(labels = "TPR", x = 0.20, y = 0.015, xpd = NA, pos = 4, cex = cexP, font =1)
text(labels = "(a)", x = 0.02, y = 1.08, xpd = NA, pos = 2, cex = cexP*1.1, font =2)
dictonary = c("DNN", "kNN", "RF", "BRT","GLM")
names(dictonary) = c("regr.negBinDnn.tuned", "regr.kknn.tuned", "regr.randomForest.tuned", "regr.xgboost.tuned","glm")
ResReg = bind_rows(resAggMiddleReg[,c(1,2,3,9)])
ResRegT = tapply(ResReg$trp, list(factor(ResReg$len_true),ResReg$model), simplify = TRUE, FUN = function(i) i)
ResRegTCI = tapply(ResReg$tprCI, list(factor(ResReg$len_true),ResReg$model), simplify = TRUE, FUN = function(i)i)
means = apply(ResRegT, 2, mean)
#ord = order(means, decreasing = TRUE)
ord = sapply(right_order, function(x) which(x == dictonary[colnames(ResRegT)], arr.ind = TRUE))
coords = plotInf(ResRegT[,ord], ResRegTCI[,ord], between = 0.4)
axis(2, las = 2, cex.axis = cexP, tck = -0.02)
text(labels = dictonary[colnames(ResRegT)[ord]], 
     x = apply(coords,1, function(co) mean(co)), y = -0.02, pos = 1, xpd = NA, cex = cexP)
text(labels = "TPR", x = 0.20, y = 0.015, xpd = NA, pos = 4, cex = cexP, font =1)
text(labels = "(b)", x = 0.02, y = 1.08, xpd = NA, pos = 2, cex = cexP*1.1, font =2)
dev.off()



```




## Figure S4
goodness of fit on train for appendix

```{r, results=FALSE}
load(file = "Results/HummingInferenceResult.RData")
load(file = "Results/HummingBirdResult.RData")
addA = TraitMatching:::addA
models = list(modelRF = modelRF, modelBoost = modelBoost, modelNegBin = modelNegBin, modelPoisson = modelPoisson)
plotNames = names(community)
predList = vector("list", length(community)*length(models))
counter = 1
for(m in 1:length(models)){
  for(i in 1:length(community)){
    data = community[[i]]$data[,-c(1,2)]
    predList[[counter]] = predict(models[[m]][[i]], newdata = data)$data
    names(predList)[[counter]] = paste0(names(models)[[m]], "_", plotNames[i])
    counter = counter + 1
  }
}
cols = c("#009BB2", "#FF8D30")
colsInner = addA(cols, 0.3)
pos = matrix(0, nrow = 28, ncol = 4)
pos[,1] = c(sapply(0:3, function(x) return(rep(0+x*0.25, 7))))
pos[,2] = c(sapply(1:4, function(x) return(rep(0+x*0.25, 7))))
pos[,3] = rep(seq(1,0,length.out = 8)[2:8], 4)
pos[,4] = rep(seq(1,0,length.out = 8)[1:7], 4)
lwd = 1.0
svg(file = "Figures/FigS4.svg")
par(mar = c(0.5,.2,.5,.2)-0.1, oma = c(2, 2, 2, 2), xaxt = "s", yaxt = "s", mgp = c(1,1,0))
plotNames = c("Low", "Mid", "High", "Mid+High", "Low+Mid", "Low+High" , "All")
labelCounter = 1
for(counter in 1:28){
  if(counter == 1) par(fig = pos[counter,])
  else par(fig = pos[counter,], new = T)
  maxV = max(predList[[counter]][,1:2])*1.2
  plot(predList[[counter]][,c(2,1)], xlim = c(-3,maxV), ylim = c(-3, maxV), axes = F, col = "black", pch = 16, xlab = "", ylab = "", cex = 0.5)
  lines(x = c(-2,maxV*0.7), y = c(-2,maxV*0.7))
  par(mgp = c(1,0.04,0))
  axis(1,cex.axis = 0.5, las = 1)
  par(mgp = c(1,0.504,0))
  axis(2,cex.axis = 0.5, las = 1 )
  spear = round(measureSpearmanRho(predList[[counter]][,1], predList[[counter]][,2]),digits = 3)
  text(x = 0.1*maxV, y = maxV*0.5, labels = spear, cex = 0.5, font = 2, pos = 3, col = "blue")
  if(counter > 21){
    text(x = maxV*1.2, y = maxV*0.3, labels = plotNames[labelCounter], cex = 0.8, font = 2, xpd = NA, srt = 270)
    labelCounter = labelCounter+1
  }
}
mtext(outer = T, at = seq(0.15,0.87,length.out = 4),text = c("RandomForest", "BoostedTrees", "NegbinDNN", "PoissonDNN"), side = 3, font = 2, cex = 0.8) 
mtext(outer = T, side = 2, at = 0.5, cex = 0.7, font = 2, text = "true response",line = 0.9)
mtext(outer = T, side = 1, at = 0.5, cex = 0.7, font = 2, text = "predicted response",line = 0.9)
mtext(outer = T, side = 3, at = 0.0, cex = 0.5, font = 2, text = "Spearman",line = -1 , col = "blue")
dev.off()
reset()
```


## Figure S5
```{r,results=FALSE}
load(file = "Results/HummingInferenceResult.RData")
humT = c( "Bill.Length", "Bill.Curvature", "Body.Mass","Wing" , "Tail" )
plantT = c( "Corolla.Length","Corolla.Curvature", "Corolla.Volumen","Inner.Diameter", "Ext.Diameter")
interHum = apply(rbind(expand.grid(humT, plantT), expand.grid( plantT, humT)), 1, function(x) paste0(x[1],":", x[2]))


groups = list(a = humT, b = plantT)

best = ResultInterCombined$rf
best$pairwise_interactions = best$pairwise_interactions[order(best$pairwise_interactions$Interactions,decreasing = TRUE),, drop = FALSE]
svg(file = "Figures/FigS5.svg")
modelNames = c("BRT", "NgDNN", "pDNN", "RF")
par(mfrow = c(4,4), mar = c(1.5,1,1.5,1)+0.3,oma = c(0.0,5,3,0))
for(i in 1:4){
  if(i <2) muteY = FALSE
  else muteY = TRUE
  best = ResultInterLow[[i]]
  best$pairwise_interactions = best$pairwise_interactions[order(best$pairwise_interactions$Interactions,decreasing = TRUE),, drop = FALSE]
  drawRankingMatrix2(best, groups = groups, top_n = 8L,muteY = muteY, muteX = FALSE)
  if(i == 1) text(x = -0.1, y = 1.2, xpd = NA, font = 2, cex = 0.9, labels = "Low")
  text(x = 0.5, y = 0.05, labels = modelNames[i],pos = 3, cex = 0.7, font = 2, xpd = NA)
}

for(i in 1:4){
  if(i <2) muteY = FALSE
  else muteY = TRUE
  best = ResultInterMid[[i]]
  best$pairwise_interactions = best$pairwise_interactions[order(best$pairwise_interactions$Interactions,decreasing = TRUE),, drop = FALSE]
  drawRankingMatrix2(best, groups = groups, top_n = 8L,muteY = muteY,muteX = TRUE)  
  if(i == 1) text(x =  -0.1, y = 1.2, xpd = NA, font = 2, cex = 0.9, labels = "Mid")
  text(x = 0.5, y = 0.05, labels = modelNames[i],pos = 3, cex = 0.7, font = 2, xpd = NA)
}

for(i in 1:4){
  if(i <2) muteY = FALSE
  else muteY = TRUE
 best = ResultInterHigh[[i]]
 best$pairwise_interactions = best$pairwise_interactions[order(best$pairwise_interactions$Interactions,decreasing = TRUE),, drop = FALSE]
 drawRankingMatrix2(best, groups = groups, top_n = 8L,muteY = muteY,muteX = TRUE)  
 if(i == 1) text(x =  -0.1, y = 1.2, xpd = NA, font = 2, cex = 0.9, labels = "High")
  text(x = 0.5, y = 0.05, labels = modelNames[i],pos = 3, cex = 0.7, font = 2, xpd = NA)
}

for(i in 1:4){
    if(i <2) muteY = FALSE
  else muteY = TRUE
 best = ResultInterCombined[[i]]
 best$pairwise_interactions = best$pairwise_interactions[order(best$pairwise_interactions$Interactions,decreasing = TRUE),, drop = FALSE]

 drawRankingMatrix2(best, groups = list(a = c(humT,"plot.Low", "plot.Mid", "plot.High"), b = c(plantT)), top_n = 8L,muteY = muteY,muteX = TRUE)  
  if(i == 1) text(x =  -0.1, y = 1.2, xpd = NA, font = 2, cex = 0.9, labels = "All")
  text(x = 0.5, y = 0.05, labels = modelNames[i],pos = 3, cex = 0.7, font = 2, xpd = NA)
  if(i == 2){
    for(i in 1:8){
  rect(ytop = -0.04,ybottom = -0.07,xleft = seq(0.0,1,length.out = 9)[i]+0.5,xright = seq(0,1,length.out = 9)[i+1]+0.5, col = RColorBrewer::brewer.pal(8,name = "YlGnBu")[i],border = NA, xpd = NA)
}
text(y= -0.07,x = seq(0, seq(0,1,length.out = 9)[8], length.out = 8)+0.55, labels = 8:1, pos = 1, font = 2, cex = 0.7, xpd = NA)
  }
}
dev.off()

```



## Table S4

```{r,include=FALSE}
bestTestTable = bestTest[order(bestTest$tss, decreasing = F),]
test = test[order(test$method),]
#Full for appendix
print(xtable::xtable(test, auto = T, digits = 3), include.rownames=FALSE)
#Small
print(xtable::xtable(bestTestTable[,c(1,2,4,5,8,9,10,11,13)], auto = T, digits = 3), include.rownames=FALSE)

tablePaper = bestTestTable[,c(1,2,4,5,8,9,10,11,13)]
tablePaper[,1:8] = apply(tablePaper[,1:8], 2, FUN = function(x) round(x, digits = 3))
write_csv(tablePaper, path = "./Figures/resultsPollinator.csv")

```

<!-- ## Table S4 -->
<!-- ```{r,include=FALSE} -->
<!-- bestTestTable = bestTest[order(bestTest$sensitivity, decreasing = T),] -->
<!-- test = test[order(test$method),] -->
<!-- #Full for appendix -->
<!-- kableExtra::landscape(knitr::kable(test,digits = 3, format = "latex",  longtable = TRUE, row.names = F)) -->
<!-- #Small -->
<!-- knitr::kable(bestTestTable[,c(1,2,4,5,8,9,10,11,13)], "latex", digits = 3,row.names = F) -->
<!-- ``` -->



## Table S4
```{r}
results = rbind(baseC, baseCTSS)
results = round(results,2)
results = cbind(data.frame(Measure = c("AUC", "TSS")), results)

# Reorder for rbind:
reg = data.frame((c("Spearman",baseR[,1], NA, baseR[,3], NA, baseR[,2], baseR[,4:7])))
reg =  data.frame(lapply(reg, function(i) if(is.numeric(i)) return(round(i,2)) else return(i)))
colnames(reg) = colnames(results)
results = rbind(results, reg)
print(results)
write.csv(results, file = "./Results/BaselineResults.csv")
```

## Table S5
```{r}
resultsE = round(aucGenSize,3)*100
resultsE = cbind(data.frame(NetworkSize = c("20*50", "50*100", "100*200")),DeacreaseInPercent = rep("AUC",3), resultsE)
spearGenSizeP = round(spearGenSize,3)*100
regE = cbind(NetworkSize = c("20*50", "50*100", "100*200"),data.frame("Spearman",spearGenSizeP[,1], NA, spearGenSizeP[,3], NA, spearGenSizeP[,2], spearGenSizeP[,4:7]))
colnames(regE) = colnames(resultsE)
resultsE = rbind(resultsE, regE)
print(resultsE)
write.csv(resultsE, file = "./Results/GeneralizationError.csv")

```